# WhatsApp Media Crypto

Библиотека для шифрования и дешифрования медиафайлов с использованием алгоритмов WhatsApp. Реализует PSR-7 совместимые потоковые декораторы.

## Требования

- PHP 7.4+
- OpenSSL extension
- Composer

## Установка

```bash
composer require your-vendor/whatsapp-media-crypto
```

## Основные возможности

- PSR-7 совместимые потоковые декораторы
- Поддержка различных типов медиа (изображения, видео, аудио, документы)
- Потоковая обработка больших файлов
- Встроенная генерация sidecar для стриминга видео и аудио
- Строгая типизация и полная документация
- 100% покрытие тестами

## Структура проекта

```
src/
├── Stream/
│   ├── AbstractCryptoStream.php    # Базовый класс для криптографических потоков
│   ├── EncryptingStream.php        # Реализация шифрования
│   └── DecryptingStream.php        # Реализация дешифрования
├── HKDF.php                        # Реализация HKDF
├── MediaKey.php                    # Работа с медиа-ключами
└── StreamFactory.php               # Фабрика для создания потоков
```

## Примеры использования

### Шифрование изображений

```php
use WhatsAppMedia\StreamFactory;
use GuzzleHttp\Psr7\Utils;

$source = Utils::streamFor(fopen('image.jpg', 'rb'));
$mediaKey = file_get_contents('image.key');

$encryptedStream = StreamFactory::createEncryptingStream(
    $source,
    $mediaKey,
    'IMAGE'
);
```

### Шифрование видео/аудио с генерацией сайдкара

```php
$source = Utils::streamFor(fopen('video.mp4', 'rb'));
$mediaKey = file_get_contents('video.key');

$encryptedStream = StreamFactory::createEncryptingStream(
    $source,
    $mediaKey,
    'VIDEO',
    true // включаем генерацию сайдкара
);

// После шифрования получаем сайдкар
$sidecar = $encryptedStream->getSidecar();
```

### Дешифрование файлов

```php
$encrypted = Utils::streamFor(fopen('encrypted_file', 'rb'));
$mediaKey = file_get_contents('file.key');

$decryptedStream = StreamFactory::createDecryptingStream(
    $encrypted,
    $mediaKey,
    'VIDEO' // или 'AUDIO', 'IMAGE', 'DOCUMENT'
);
```

## Поддерживаемые типы медиа

| Тип      | Описание     | Информационная строка    | Поддержка сайдкара |
|----------|--------------|-------------------------|-------------------|
| IMAGE    | Изображения  | WhatsApp Image Keys    | Нет              |
| VIDEO    | Видео       | WhatsApp Video Keys    | Да               |
| AUDIO    | Аудио       | WhatsApp Audio Keys    | Да               |
| DOCUMENT | Документы    | WhatsApp Document Keys | Нет              |

## Готовые примеры

В директории `examples/` доступны готовые скрипты:

### Шифрование
- `encrypt_image.php` - шифрование изображений
- `encrypt_video_streaming.php` - шифрование видео с генерацией сайдкара
- `encrypt_audio_streaming.php` - шифрование аудио с генерацией сайдкара
- `encrypt_audio.php` - базовое шифрование аудио
- `encrypt_video.php` - базовое шифрование видео

### Дешифрование
- `decrypt_video.php` - дешифрование видео
- `decrypt_audio.php` - дешифрование аудио
- `decrypt_image.php` - дешифрование изображений

Все примеры включают:
- Проверки существования файлов
- Создание выходных директорий
- Обработку ошибок
- Информацию о размерах файлов

## Особенности реализации

### Шифрование

1. Генерация или использование существующего mediaKey (32 байта)
2. Расширение ключа через HKDF с SHA-256 и специфичной для типа медиа информацией
3. Разделение на компоненты:
   - iv: первые 16 байт
   - cipherKey: следующие 32 байта
   - macKey: следующие 32 байта
   - refKey: оставшиеся 32 байта (не используются)
4. Шифрование AES-CBC с использованием cipherKey и iv
5. Генерация HMAC с macKey

### Генерация сайдкара (для видео и аудио)

- Размер чанка: 64KB
- Перекрытие: 16 байт
- HMAC SHA-256 для каждого чанка, обрезанный до 10 байт
- Генерация "на лету" без дополнительных чтений из потока

## Тестирование

```bash
composer install
vendor/bin/phpunit
```

### Покрытие тестами

Тесты охватывают все требования задания:

1. Базовая функциональность:
   - Шифрование/дешифрование для всех типов медиа
   - Корректная работа с различными размерами файлов
   - Проверка соответствия результатов с эталонными файлами

2. Генерация сайдкара (задание со звёздочкой):
   - Генерация для видео и аудио файлов
   - Проверка соответствия с эталонными сайдкарами
   - Валидация форматов и размеров

3. Edge cases:
   - Проверка некорректного MAC
   - Обработка пустых потоков
   - Валидация длины ключей
   - Проверка неподдерживаемых типов медиа

## Безопасность

- Валидация всех входных данных
- Проверка MAC для каждого чанка
- Безопасная работа с криптографическими примитивами
- Корректная обработка ошибок
- Проверка целостности данных

## Лицензия

MIT License
